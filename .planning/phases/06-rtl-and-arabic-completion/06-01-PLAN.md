---
phase: 06-rtl-and-arabic-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - front/package.json
  - front/public/css/bootstrap.min.css
  - front/public/css/bootstrap.rtl.min.css
  - front/index.html
  - front/src/lib/rtl.ts
  - front/src/app-frontend/components/modes/topbar.right.tsx
  - front/src/app-admin/containers/layout/navbar.tsx
  - front/src/css/ltr.scss
  - front/src/index.tsx
autonomous: true
requirements:
  - I18N-03
  - I18N-04

must_haves:
  truths:
    - "Tailwind 3.3+ is installed and ms-*/me-*/ps-*/pe-* utility classes are available in dev builds"
    - "Bootstrap CSS loads from local /css/ path, not CDN — no network request on language switch"
    - "Switching to Arabic sets dir='rtl' on the <html> element (not <body>) and swaps Bootstrap to RTL variant"
    - "Switching back to French sets dir='ltr' on <html> and swaps Bootstrap to LTR variant"
    - "Ant Design ConfigProvider wraps the entire app with direction='rtl' when Arabic is active"
    - "Arabic text in the web UI renders in Noto Sans Arabic font, not the Latin Manrope font"
    - "Language switching works identically in both POS and Admin apps via the shared applyLocale() utility"
  artifacts:
    - path: "front/public/css/bootstrap.min.css"
      provides: "Local Bootstrap 5.2.0 LTR CSS"
    - path: "front/public/css/bootstrap.rtl.min.css"
      provides: "Local Bootstrap 5.2.0 RTL CSS"
    - path: "front/src/lib/rtl.ts"
      provides: "Shared applyLocale() utility for language/direction switching"
      exports: ["applyLocale"]
    - path: "front/index.html"
      provides: "Local Bootstrap CSS link (not CDN)"
      contains: "/css/bootstrap.min.css"
    - path: "front/src/index.tsx"
      provides: "ConfigProvider wrapper with reactive direction"
      contains: "ConfigProvider"
  key_links:
    - from: "front/src/lib/rtl.ts"
      to: "front/src/app-frontend/components/modes/topbar.right.tsx"
      via: "import { applyLocale }"
      pattern: "applyLocale"
    - from: "front/src/lib/rtl.ts"
      to: "front/src/app-admin/containers/layout/navbar.tsx"
      via: "import { applyLocale }"
      pattern: "applyLocale"
    - from: "front/src/index.tsx"
      to: "antd ConfigProvider"
      via: "i18n.on('languageChanged') -> setDirection"
      pattern: "ConfigProvider direction"
---

<objective>
Set up the RTL infrastructure: upgrade TailwindCSS to unlock logical properties, serve Bootstrap CSS locally to eliminate CDN race conditions, create a shared locale-switching utility, add Arabic web font declarations, and wrap the app in Ant Design ConfigProvider with reactive direction.

Purpose: All subsequent RTL work (class migration, translation fill) depends on this infrastructure being in place first.
Output: Working language switch that correctly sets dir="rtl" on <html>, swaps local Bootstrap CSS, triggers ConfigProvider direction update, and renders Arabic text in the correct font.
</objective>

<execution_context>
@/Users/abdellahi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abdellahi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rtl-and-arabic-completion/06-RESEARCH.md

@front/package.json
@front/index.html
@front/tailwind.config.js
@front/src/index.tsx
@front/src/i18next.ts
@front/src/css/ltr.scss
@front/src/app-frontend/components/modes/topbar.right.tsx
@front/src/app-admin/containers/layout/navbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Tailwind and install Bootstrap locally</name>
  <files>
    front/package.json
    front/public/css/bootstrap.min.css
    front/public/css/bootstrap.rtl.min.css
    front/index.html
  </files>
  <action>
1. In `front/`, run:
   ```bash
   npm install tailwindcss@^3.3.0
   npm install bootstrap@5.2.0
   ```
   This upgrades Tailwind from 3.1.8 to 3.3.x (no breaking changes, adds ms-*/me-*/ps-*/pe-* logical property utilities) and installs Bootstrap 5.2.0 as a local dependency.

2. Create `front/public/css/` directory and copy the Bootstrap CSS files from node_modules:
   ```bash
   mkdir -p front/public/css
   cp front/node_modules/bootstrap/dist/css/bootstrap.min.css front/public/css/bootstrap.min.css
   cp front/node_modules/bootstrap/dist/css/bootstrap.rtl.min.css front/public/css/bootstrap.rtl.min.css
   ```

3. Update `front/index.html` line 16 — change the CDN link to local path:
   ```html
   <link id="bootstrap-css" rel="stylesheet" href="/css/bootstrap.min.css" />
   ```

4. Update the inline script in `front/index.html` (lines 18-28) — change the CDN URL in the Arabic branch to local path:
   ```html
   <script>
     (function() {
       var locale = localStorage.getItem('locale');
       if (locale === 'ar') {
         document.documentElement.setAttribute('dir', 'rtl');
         document.documentElement.setAttribute('lang', 'ar');
         document.getElementById('bootstrap-css').setAttribute('href', '/css/bootstrap.rtl.min.css');
       } else {
         document.documentElement.setAttribute('lang', 'fr');
       }
     })();
   </script>
   ```
   Note: The inline script already correctly uses `document.documentElement.setAttribute` — only the href URL needs changing from CDN to `/css/bootstrap.rtl.min.css`.

5. Verify Tailwind upgrade: run `npx tailwindcss --help` to confirm version is 3.3.x+. Also check that `node_modules/tailwindcss/package.json` shows version >=3.3.0.
  </action>
  <verify>
- `cat front/node_modules/tailwindcss/package.json | grep version` shows 3.3.x or higher
- `ls front/public/css/` shows both `bootstrap.min.css` and `bootstrap.rtl.min.css`
- `grep "cdn.jsdelivr" front/index.html` returns no matches (CDN references removed)
- `grep "/css/bootstrap.min.css" front/index.html` returns the link tag
- `cd front && npm run build` completes without errors
  </verify>
  <done>
- TailwindCSS >=3.3.0 installed in devDependencies (ms-*/me-*/ps-*/pe-* utilities now available)
- Bootstrap 5.2.0 LTR and RTL CSS files served locally from public/css/
- index.html references local Bootstrap paths, no CDN URLs remain
- Vite build succeeds with the updated dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared RTL utility, update language switchers, add Arabic font, add ConfigProvider</name>
  <files>
    front/src/lib/rtl.ts
    front/src/app-frontend/components/modes/topbar.right.tsx
    front/src/app-admin/containers/layout/navbar.tsx
    front/src/css/ltr.scss
    front/src/index.tsx
  </files>
  <action>
1. **Create `front/src/lib/rtl.ts`** — the shared locale-switching utility:
   ```typescript
   import i18n from '../i18next';

   export async function applyLocale(lang: string) {
     localStorage.setItem('locale', lang);
     await i18n.changeLanguage(lang);
     const dir = i18n.dir(lang);
     document.documentElement.dir = dir;
     document.documentElement.lang = lang;
     const css = document.getElementById('bootstrap-css');
     if (css) {
       css.setAttribute('href', lang === 'ar'
         ? '/css/bootstrap.rtl.min.css'
         : '/css/bootstrap.min.css'
       );
     }
   }
   ```
   Note: Uses `document.documentElement.dir` (targets `<html>`, NOT `document.dir` which targets `<body>`). Uses `i18n.dir(lang)` from i18next (confirmed API in v21.8.16) rather than hardcoding 'rtl'/'ltr'.

2. **Update `front/src/app-frontend/components/modes/topbar.right.tsx`** — replace the inline `toggleLocale` function (lines 29-47) with a call to the shared utility:
   - Import `applyLocale` from `../../../lib/rtl`
   - Remove the `i18next` import (no longer needed directly)
   - Replace the `toggleLocale` function body with:
     ```typescript
     const toggleLocale = () => {
       const newLocale = locale === 'fr' ? 'ar' : 'fr';
       setLocale(newLocale);
       applyLocale(newLocale);
     };
     ```
   - This removes the CDN URLs and `document.dir` bug from the POS language switcher.

3. **Update `front/src/app-admin/containers/layout/navbar.tsx`** — replace the inline `updateLocale` function (lines 25-51) with a call to the shared utility:
   - Import `applyLocale` from `../../../lib/rtl`
   - Remove the `i18next` import (no longer needed directly)
   - Replace the `updateLocale` function body:
     ```typescript
     const updateLocale = async (lang: string) => {
       setLocale(lang);
       // set on server
       await jsonRequest(UPDATE_LOCALE, {
         method: 'POST',
         body: JSON.stringify({ locale: lang })
       });
       await applyLocale(lang);
     };
     ```
   - Keep the server-side locale update (`jsonRequest(UPDATE_LOCALE, ...)`), but delegate all client-side DOM/i18n work to `applyLocale()`. This removes the CDN URLs and `document.dir` bug from the Admin language switcher.

4. **Add Arabic web font to `front/src/css/ltr.scss`** — after the existing `@font-face` declarations (after line 43, the Manrope font-face block), add:
   ```scss
   @font-face {
     font-family: 'NotoSansArabic';
     src: url('../assets/fonts/NotoSansArabic-Regular.ttf') format('truetype');
     font-weight: 400;
   }

   @font-face {
     font-family: 'NotoSansArabic';
     src: url('../assets/fonts/NotoSansArabic-Bold.ttf') format('truetype');
     font-weight: 700;
   }
   ```
   The font files already exist at `src/assets/fonts/NotoSansArabic-Regular.ttf` and `NotoSansArabic-Bold.ttf` (added in Phase 5-03 for PDF).

   Then in `front/src/css/index.scss`, inside the `[dir="rtl"]` block (line 446), add at the top of the block:
   ```scss
   [dir="rtl"] {
     html, body, button, input, optgroup, select, textarea {
       font-family: 'NotoSansArabic', sans-serif;
     }
     // ... existing RTL overrides remain ...
   }
   ```

5. **Add ConfigProvider to `front/src/index.tsx`** — wrap the entire render tree in an Ant Design ConfigProvider with reactive direction:
   - Add imports: `import { ConfigProvider } from 'antd';` and `import { useState, useEffect } from 'react';`
   - Create a wrapper component (or use inline logic) that:
     - Reads initial direction from `i18n.dir(localStorage.getItem('locale') ?? 'fr')`
     - Listens to `i18n.on('languageChanged', ...)` to update direction reactively
     - Wraps the existing JSX tree in `<ConfigProvider direction={direction}>`
   - The ConfigProvider must be INSIDE the I18nextProvider (so i18n is available) and wrap the ApolloProvider + app rendering.
   - Example restructure of the render call:
     ```tsx
     const AppWithDirection = () => {
       const [direction, setDirection] = useState<'ltr' | 'rtl'>(
         i18n.dir(localStorage.getItem('locale') ?? 'fr') as 'ltr' | 'rtl'
       );
       useEffect(() => {
         const handler = (lng: string) => {
           setDirection(i18n.dir(lng) as 'ltr' | 'rtl');
         };
         i18n.on('languageChanged', handler);
         return () => { i18n.off('languageChanged', handler); };
       }, []);
       return (
         <ConfigProvider direction={direction}>
           <ApolloProvider client={client}>
             {import.meta.env.VITE_APP_TYPE === 'frontend' ? <Frontend /> : <Admin />}
           </ApolloProvider>
         </ConfigProvider>
       );
     };
     ```
   - Then use `<AppWithDirection />` inside the existing provider tree.
  </action>
  <verify>
- `grep "applyLocale" front/src/lib/rtl.ts` confirms the utility exists
- `grep "applyLocale" front/src/app-frontend/components/modes/topbar.right.tsx` confirms POS uses shared utility
- `grep "applyLocale" front/src/app-admin/containers/layout/navbar.tsx` confirms Admin uses shared utility
- `grep "cdn.jsdelivr" front/src/app-frontend/components/modes/topbar.right.tsx front/src/app-admin/containers/layout/navbar.tsx` returns no matches (CDN references removed from both switchers)
- `grep "document.dir" front/src/app-frontend/components/modes/topbar.right.tsx front/src/app-admin/containers/layout/navbar.tsx` returns no matches (bug removed from both switchers)
- `grep "NotoSansArabic" front/src/css/ltr.scss` confirms @font-face declarations
- `grep "ConfigProvider" front/src/index.tsx` confirms ConfigProvider is wrapped
- `cd front && npm run build` completes without errors
  </verify>
  <done>
- Shared `applyLocale()` utility in `src/lib/rtl.ts` handles all locale-switching DOM operations
- POS topbar.right.tsx calls `applyLocale()` — no more inline CDN swap or `document.dir` bug
- Admin navbar.tsx calls `applyLocale()` — no more inline CDN swap or `document.dir` bug
- Arabic @font-face (NotoSansArabic Regular + Bold) declared in ltr.scss
- `[dir="rtl"]` CSS applies NotoSansArabic as body font
- Ant Design ConfigProvider at app root with reactive direction from i18n.on('languageChanged')
- Vite build succeeds
  </done>
</task>

</tasks>

<verification>
1. Run `cd front && npm run build` — must succeed with zero errors
2. Verify no CDN references remain: `grep -r "cdn.jsdelivr" front/index.html front/src/` should return nothing
3. Verify no `document.dir =` pattern remains in switchers: `grep -r "document\.dir" front/src/app-frontend/components/modes/topbar.right.tsx front/src/app-admin/containers/layout/navbar.tsx` should return nothing
4. Verify ConfigProvider exists: `grep "ConfigProvider" front/src/index.tsx` should match
5. Verify local Bootstrap files: `ls front/public/css/bootstrap*.css` should list both files
6. Verify Tailwind version: `node -e "console.log(require('front/node_modules/tailwindcss/package.json').version)"` should show 3.3.x+
</verification>

<success_criteria>
- TailwindCSS >=3.3.0 installed, enabling ms-*/me-*/ps-*/pe-* logical utility classes
- Bootstrap CSS served from local public/css/ files, zero CDN references anywhere in the codebase
- Language switching correctly sets dir="rtl" on <html> element via shared applyLocale() utility
- Ant Design ConfigProvider wraps entire app with direction="rtl" when Arabic is active
- Arabic web font (Noto Sans Arabic) declared in CSS and applied via [dir="rtl"] selector
- Both POS and Admin language switchers use the shared utility — no duplicated logic
- Vite production build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-rtl-and-arabic-completion/06-01-SUMMARY.md`
</output>
