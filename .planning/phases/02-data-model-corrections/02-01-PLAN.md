---
phase: 02-data-model-corrections
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - back/src/Entity/Closing.php
  - back/src/Entity/OrderProduct.php
  - back/src/Entity/User.php
  - back/src/Core/Closing/Command/CreateClosingCommand/CreateClosingCommand.php
  - back/src/Core/Closing/Command/UpdateClosingCommand/UpdateClosingCommand.php
  - back/src/Core/Closing/Query/SelectClosingQuery/SelectClosingQuery.php
  - back/src/Core/Dto/Common/Closing/ClosingDto.php
  - back/src/Core/Discount/Command/CreateDiscountCommand/CreateDiscountCommand.php
  - back/src/Core/Discount/Command/CreateDiscountCommand/CreateDiscountCommandHandler.php
  - back/src/Core/Discount/Command/CreateDiscountCommand/CreateDiscountCommandHandlerInterface.php
  - back/src/Core/Discount/Command/CreateDiscountCommand/CreateDiscountCommandResult.php
  - back/src/Core/Dto/Controller/Api/Admin/Discount/CreateDiscountRequestDto.php
  - back/src/Core/Dto/Controller/Api/Admin/Discount/UpdateDiscountRequestDto.php
  - back/migrations/
autonomous: true
requirements:
  - DATA-02

must_haves:
  truths:
    - "Closing entity financial columns are stored as DECIMAL(20,2) in the database, not float/DOUBLE"
    - "OrderProduct has a costAtSale column that snapshots the product cost at order creation time"
    - "User.roles is stored as JSON in the database, not PHP serialized array"
    - "The Core/Discont typo namespace is eliminated and all references point to Core/Discount"
    - "Existing data is preserved through migration -- no data loss on Closing balances, User roles, or OrderProduct records"
  artifacts:
    - path: "back/src/Entity/Closing.php"
      provides: "Closing entity with decimal(20,2) financial columns"
      contains: 'type="decimal", precision=20, scale=2'
    - path: "back/src/Entity/OrderProduct.php"
      provides: "OrderProduct entity with costAtSale column"
      contains: "costAtSale"
    - path: "back/src/Entity/User.php"
      provides: "User entity with JSON roles column"
      contains: 'type="json"'
    - path: "back/migrations/"
      provides: "Doctrine migration(s) for schema + data changes"
  key_links:
    - from: "back/src/Entity/Closing.php"
      to: "back/src/Core/Closing/Command/CreateClosingCommand/CreateClosingCommand.php"
      via: "DTO type hints must match entity return types"
      pattern: "\\?string"
    - from: "back/src/Core/Discont/"
      to: "back/src/Core/Discount/Command/CreateDiscountCommand/"
      via: "Files moved from typo namespace to correct namespace"
      pattern: "App\\\\Core\\\\Discount"
    - from: "back/src/Entity/OrderProduct.php"
      to: "back/src/Core/Order/Command/CreateOrderCommand/CreateOrderCommandHandler.php"
      via: "costAtSale must be set when creating an order"
      pattern: "setCostAtSale"
---

<objective>
Schema migrations: Migrate Closing entity float columns to decimal(20,2), add OrderProduct.costAtSale column with data backfill, convert User.roles from PHP serialized array to JSON, fix Core/Discont namespace typo, and update all related DTOs/Commands.

Purpose: Establish correct data types in the database so financial calculations are precise (no float rounding), historical profit reports are possible (costAtSale snapshot), and data is stored in portable formats (JSON not PHP serialize). This is the foundation for all reporting features in Phases 3-5.

Output: Modified entity files, updated DTO/Command type hints, new Doctrine migration(s), Discont->Discount namespace fix.
</objective>

<execution_context>
@/Users/abdellahi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abdellahi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-model-corrections/02-RESEARCH.md
@back/src/Entity/Closing.php
@back/src/Entity/OrderProduct.php
@back/src/Entity/User.php
@back/src/Core/Closing/Command/CreateClosingCommand/CreateClosingCommand.php
@back/src/Core/Closing/Command/UpdateClosingCommand/UpdateClosingCommand.php
@back/src/Core/Closing/Query/SelectClosingQuery/SelectClosingQuery.php
@back/src/Core/Dto/Common/Closing/ClosingDto.php
@back/src/Core/Discont/Command/CreateDiscountCommand/CreateDiscountCommand.php
@back/src/Core/Discont/Command/CreateDiscountCommand/CreateDiscountCommandHandler.php
@back/src/Core/Discont/Command/CreateDiscountCommand/CreateDiscountCommandHandlerInterface.php
@back/src/Core/Discont/Command/CreateDiscountCommand/CreateDiscountCommandResult.php
@back/src/Core/Dto/Controller/Api/Admin/Discount/CreateDiscountRequestDto.php
@back/src/Core/Dto/Controller/Api/Admin/Discount/UpdateDiscountRequestDto.php
@back/src/Core/Order/Command/CreateOrderCommand/CreateOrderCommandHandler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Entity annotations, DTO type hints, and namespace fix</name>
  <files>
    back/src/Entity/Closing.php
    back/src/Entity/OrderProduct.php
    back/src/Entity/User.php
    back/src/Core/Closing/Command/CreateClosingCommand/CreateClosingCommand.php
    back/src/Core/Closing/Command/UpdateClosingCommand/UpdateClosingCommand.php
    back/src/Core/Closing/Query/SelectClosingQuery/SelectClosingQuery.php
    back/src/Core/Dto/Common/Closing/ClosingDto.php
    back/src/Core/Discount/Command/CreateDiscountCommand/CreateDiscountCommand.php
    back/src/Core/Discount/Command/CreateDiscountCommand/CreateDiscountCommandHandler.php
    back/src/Core/Discount/Command/CreateDiscountCommand/CreateDiscountCommandHandlerInterface.php
    back/src/Core/Discount/Command/CreateDiscountCommand/CreateDiscountCommandResult.php
    back/src/Core/Dto/Controller/Api/Admin/Discount/CreateDiscountRequestDto.php
    back/src/Core/Dto/Controller/Api/Admin/Discount/UpdateDiscountRequestDto.php
    back/src/Core/Order/Command/CreateOrderCommand/CreateOrderCommandHandler.php
  </files>
  <action>
    **A. Closing.php -- Change 5 float columns to decimal(20,2):**
    Change the ORM annotation on these 5 properties from `@ORM\Column(type="float", nullable=true)` to `@ORM\Column(type="decimal", precision=20, scale=2, nullable=true)`:
    - `$openingBalance`
    - `$closingBalance`
    - `$cashAdded`
    - `$cashWithdrawn`
    - `$expenses`

    Update the getter return types from `?float` to `?string` and setter parameter types from `?float` to `?string` for all 5 fields. Doctrine decimal returns PHP string to preserve precision.

    **B. OrderProduct.php -- Add costAtSale column:**
    Add a new property `$costAtSale` with annotation:
    ```php
    /**
     * @ORM\Column(type="decimal", precision=20, scale=2, nullable=true)
     * @Groups({"order.read","customer.read"})
     */
    private $costAtSale;
    ```
    Add getter `getCostAtSale(): ?string` and setter `setCostAtSale(?string $costAtSale): self` following the exact pattern of the existing `$price` property.

    **C. User.php -- Change roles from array to json:**
    Change the ORM annotation on `$roles` from `@ORM\Column(type="array")` to `@ORM\Column(type="json")`. The getter/setter signatures remain `array` -- only the storage serialization format changes.

    **D. Closing Command/Query/DTO type hints:**
    In `CreateClosingCommand.php`, `UpdateClosingCommand.php`, and `SelectClosingQuery.php`: change `?float` type hints to `?string` on getters/setters for all financial fields (openingBalance, closingBalance, cashAdded, cashWithdrawn, expenses).

    In `ClosingDto.php`: change property types from `?float` to `?string` for financial fields. In the `createFromClosing()` static factory method, keep the entity getter calls as-is (they now return `?string`). For JSON serialization backward compatibility, cast to `(float)` in the DTO public getters so the frontend receives numbers, not strings. This preserves backward compatibility -- the precision benefit is in database storage and SQL computation.

    **E. Discont namespace fix:**
    1. Move the 4 files from `back/src/Core/Discont/Command/CreateDiscountCommand/` to `back/src/Core/Discount/Command/CreateDiscountCommand/` (the destination directory does NOT already have these files -- it has Delete/Update/Query but NOT CreateDiscountCommand/).
    2. Update the namespace declaration in all 4 moved files from `App\Core\Discont\Command\CreateDiscountCommand` to `App\Core\Discount\Command\CreateDiscountCommand`.
    3. Update the `use` statement in `CreateDiscountRequestDto.php` from `use App\Core\Discont\Command\CreateDiscountCommand\CreateDiscountCommand;` to `use App\Core\Discount\Command\CreateDiscountCommand\CreateDiscountCommand;`.
    4. Update the `use` statement in `UpdateDiscountRequestDto.php` similarly.
    5. Delete the now-empty `back/src/Core/Discont/` directory tree.

    **F. CreateOrderCommandHandler.php -- Snapshot costAtSale:**
    In the `handle()` method, inside the loop that creates OrderProduct items, add `$orderProduct->setCostAtSale($product->getCost());` right after `$orderProduct->setProduct($product)`. This snapshots the current product cost at the time of sale. Read the file carefully to find the exact insertion point -- it should be in the foreach loop that iterates over `$command->getItems()`.

    **IMPORTANT:** Do NOT change Product.php -- Product.cost is already `decimal(20,2)` per research findings. The roadmap description was based on stale analysis.
  </action>
  <verify>
    1. Run `docker exec dev-php-polymer php /var/www/html/polymer/bin/console cache:clear` -- must complete without "Class not found" errors (validates namespace fix).
    2. Grep for any remaining references to `Discont` (typo): `grep -r "Discont" back/src/` should return zero results.
    3. Grep for `type="float"` in Closing.php: `grep 'type="float"' back/src/Entity/Closing.php` should return zero results.
    4. Grep for `type="array"` in User.php: `grep 'type="array"' back/src/Entity/User.php` should return zero results.
    5. Grep for `costAtSale` in OrderProduct.php: should return the property and getter/setter.
    6. Grep for `setCostAtSale` in CreateOrderCommandHandler.php: should return 1 result.
  </verify>
  <done>
    - Closing.php has 5 columns with `type="decimal", precision=20, scale=2` and `?string` getter/setter types
    - OrderProduct.php has `costAtSale` property with decimal(20,2) annotation, getter, and setter
    - User.php has `type="json"` on roles column
    - All Closing Command/Query/DTO files use `?string` for financial fields; ClosingDto casts to `(float)` for JSON output
    - Core/Discont/ directory no longer exists; files are in Core/Discount/Command/CreateDiscountCommand/
    - CreateDiscountRequestDto and UpdateDiscountRequestDto reference App\Core\Discount (not Discont)
    - CreateOrderCommandHandler snapshots costAtSale from Product.getCost()
    - Symfony cache clears without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Doctrine migrations for schema changes and data backfill</name>
  <files>
    back/migrations/
  </files>
  <action>
    **Generate and run migrations inside Docker container `dev-php-polymer`.**

    **Step 1: Generate schema diff migration.**
    Run: `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:migrations:diff`
    This will auto-generate a migration file that detects:
    - Closing: 5 columns float -> decimal(20,2)
    - OrderProduct: new costAtSale column
    - User: roles column type change (may or may not generate SQL since both `array` and `json` map to LONGTEXT/JSON in MariaDB -- if no column change is needed, the migration will only cover Closing and OrderProduct)

    **Step 2: Edit the generated migration to add data backfill.**
    Open the generated migration file and add these SQL statements to the `up()` method AFTER the schema ALTER statements:

    1. **Backfill OrderProduct.costAtSale from current Product.cost:**
    ```sql
    UPDATE order_product op
    INNER JOIN product p ON op.product_id = p.id
    SET op.cost_at_sale = COALESCE(p.cost, 0)
    WHERE op.cost_at_sale IS NULL
    ```

    2. **Convert User.roles from PHP serialized to JSON format.**
    Since MariaDB cannot natively unserialize PHP data, add PHP code to the migration's `up()` method:
    ```php
    $rows = $this->connection->fetchAllAssociative('SELECT id, roles FROM user_account');
    foreach ($rows as $row) {
        $roles = @unserialize($row['roles']);
        if ($roles === false && $row['roles'] !== 'b:0;') {
            // Already JSON or empty -- try json_decode
            $roles = json_decode($row['roles'], true);
        }
        if (!is_array($roles)) {
            $roles = ['ROLE_VENDEUR']; // safe fallback
        }
        $json = json_encode(array_values($roles));
        $this->connection->executeStatement(
            'UPDATE user_account SET roles = ? WHERE id = ?',
            [$json, $row['id']]
        );
    }
    ```
    Note: The table name is `user_account` (verify by checking the entity's `@ORM\Table` annotation or the existing Phase 1 migration that ran `UPDATE user_account`).

    **Step 3: Add the `down()` method.**
    The down() should reverse: decimal back to float on Closing, drop costAtSale column, and convert JSON roles back to serialized (best effort). This is for safety but unlikely to be used.

    **Step 4: Run the migration.**
    Run: `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:migrations:migrate --no-interaction`

    **Step 5: Validate schema sync.**
    Run: `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:schema:validate`
    Expected output should show mapping and database are in sync.

    **IMPORTANT NOTES:**
    - If `doctrine:migrations:diff` does not detect the User.roles change (because both `array` and `json` map to the same DB column type), the PHP data conversion code still must be added to ensure the stored format changes from serialized to JSON.
    - The column name for OrderProduct.costAtSale will be `cost_at_sale` (Doctrine's underscore naming strategy).
    - Check the actual column names by looking at the generated SQL -- Doctrine should handle the naming.
  </action>
  <verify>
    1. `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:schema:validate` -- must show "OK" for both mapping and database synchronization.
    2. `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:migrations:status` -- must show no pending migrations.
    3. Verify Closing column types: `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:query:sql "DESCRIBE closing"` -- openingBalance, closingBalance, cashAdded, cashWithdrawn, expenses should show DECIMAL(20,2).
    4. Verify OrderProduct has costAtSale: `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:query:sql "DESCRIBE order_product"` -- should show cost_at_sale column.
    5. Verify User.roles is JSON format: `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:query:sql "SELECT roles FROM user_account LIMIT 3"` -- should show JSON arrays like `["ROLE_VENDEUR"]`, not PHP serialized strings.
    6. Verify costAtSale backfill: `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:query:sql "SELECT COUNT(*) as total, COUNT(cost_at_sale) as with_cost FROM order_product"` -- with_cost should equal total (all rows backfilled).
  </verify>
  <done>
    - Migration file exists in back/migrations/
    - Closing table has 5 DECIMAL(20,2) columns (not DOUBLE/FLOAT)
    - OrderProduct table has cost_at_sale DECIMAL(20,2) column
    - All existing OrderProduct rows have costAtSale backfilled from Product.cost
    - All User.roles values are stored as JSON arrays
    - doctrine:schema:validate passes
    - No pending migrations
  </done>
</task>

</tasks>

<verification>
1. `docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:schema:validate` passes with mapping and database in sync.
2. `grep -r "Discont" back/src/` returns zero results.
3. `grep 'type="float"' back/src/Entity/Closing.php` returns zero results.
4. `docker exec dev-php-polymer php /var/www/html/polymer/bin/console cache:clear` succeeds without errors.
5. Closing financial columns are DECIMAL(20,2) in the database.
6. OrderProduct.cost_at_sale column exists and is populated for all rows.
7. User.roles contains valid JSON arrays.
</verification>

<success_criteria>
- All 5 Closing financial columns are decimal(20,2) in both entity annotation and database
- OrderProduct has costAtSale column with getter/setter and all existing rows backfilled
- User.roles is type="json" and all stored values are JSON format
- Core/Discont/ directory eliminated, namespace references updated
- CreateOrderCommandHandler snapshots costAtSale on new orders
- Closing DTOs/Commands use ?string types, DTO returns (float) for JSON compatibility
- doctrine:schema:validate passes
- Symfony cache:clear succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model-corrections/02-01-SUMMARY.md`
</output>
