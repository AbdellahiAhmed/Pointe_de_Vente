---
phase: 02-data-model-corrections
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - back/src/Controller/Api/Admin/ReportController.php
autonomous: true
requirements:
  - DATA-01
  - DATA-03

must_haves:
  truths:
    - "Revenue reports (sales, profit, daily) exclude orders where isSuspended is true"
    - "Payment breakdown queries exclude both suspended and returned orders"
    - "Profit calculations use OrderProduct.costAtSale instead of live Product.cost"
    - "Z-Report session data is scoped to the correct terminal and session time window"
  artifacts:
    - path: "back/src/Controller/Api/Admin/ReportController.php"
      provides: "Corrected report queries with isSuspended filter, isReturned filter on payments, costAtSale in profit, and session-scoped closing data"
      contains: "isSuspended"
  key_links:
    - from: "back/src/Controller/Api/Admin/ReportController.php"
      to: "back/src/Entity/OrderProduct.php"
      via: "Profit queries reference op.costAtSale instead of prod.cost"
      pattern: "op\\.costAtSale"
    - from: "back/src/Controller/Api/Admin/ReportController.php"
      to: "back/src/Entity/Order.php"
      via: "All revenue queries filter on isSuspended"
      pattern: "isSuspended"
---

<objective>
Query fixes: Add isSuspended filter to all ReportController revenue/profit/daily queries so suspended (parked) orders are excluded from totals. Add missing isReturned filter to payment breakdown queries. Switch profit calculations from live Product.cost to OrderProduct.costAtSale. Verify and fix session scoping for Closing/Z-Report queries.

Purpose: Fix the three confirmed data integrity bugs: (1) suspended orders inflating revenue, (2) returned orders appearing in payment totals, (3) profit reports using live cost instead of historical cost-at-sale. Also ensure Closing session queries are properly scoped by terminal for DATA-03 (Z-Report session isolation).

Output: Corrected ReportController.php with all queries properly filtered and using costAtSale.
</objective>

<execution_context>
@/Users/abdellahi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abdellahi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-model-corrections/02-RESEARCH.md
@.planning/phases/02-data-model-corrections/02-01-SUMMARY.md
@back/src/Controller/Api/Admin/ReportController.php
@back/src/Entity/Order.php
@back/src/Entity/OrderProduct.php
@back/src/Controller/Api/Admin/ClosingController.php
@back/src/Core/Closing/Query/SelectClosingQuery/SelectClosingQueryHandler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isSuspended and isReturned filters to all ReportController queries</name>
  <files>
    back/src/Controller/Api/Admin/ReportController.php
  </files>
  <action>
    Read `ReportController.php` thoroughly. There are 3 main methods: `sales()`, `profit()`, and `daily()`. Each contains multiple DQL/QueryBuilder queries. Apply these fixes to EVERY query that computes revenue, counts, or payment totals.

    **A. isSuspended filter -- add to ALL queries in ALL three methods:**

    Add this condition to every query builder that filters orders:
    ```php
    ->andWhere('o.isSuspended != :suspended OR o.isSuspended IS NULL')
    ->setParameter('suspended', true)
    ```

    OR the shorter DQL equivalent that Doctrine handles correctly:
    ```php
    ->andWhere('o.isSuspended != true OR o.isSuspended IS NULL')
    ```

    Use whichever pattern is more consistent with the existing query style in the file. The key insight from research: `isSuspended` is `nullable=true`, so you MUST include `OR o.isSuspended IS NULL` to avoid excluding completed orders where isSuspended was never set. Do NOT use `o.isSuspended = false` as that would miss NULL rows.

    **Specific queries to fix (from research):**

    In `sales()`:
    - qb (order count/revenue query) -- add isSuspended filter
    - qb2 (secondary revenue query) -- add isSuspended filter
    - qb3 (payment breakdown query) -- add isSuspended filter AND add `o.isReturned = false` filter (currently missing -- returned order payments are incorrectly included in payment totals)

    In `profit()`:
    - qb (main profit query) -- add isSuspended filter
    - qb2 (top products query) -- add isSuspended filter

    In `daily()`:
    - ALL 4 queries -- add isSuspended filter
    - Payment breakdown query -- also add `o.isReturned = false` filter (same issue as sales())

    **B. Switch profit queries from prod.cost to op.costAtSale:**

    In `profit()` method:
    - The main profit query (qb) has: `COALESCE(SUM(COALESCE(prod.cost, 0) * op.quantity), 0) as totalCost`
    - Change to: `COALESCE(SUM(COALESCE(op.costAtSale, 0) * op.quantity), 0) as totalCost`
    - The `prod` join may still be needed for product name/grouping in the top products query (qb2). Keep the join if used elsewhere, but change the cost reference.

    - The top products query (qb2) also references `prod.cost` for per-product cost:
    - Change to use `op.costAtSale` instead.

    In `daily()` method:
    - If the daily revenue query references `prod.cost` for cost calculation, change to `op.costAtSale`.

    **C. Verify session scoping for Closing queries (DATA-03):**

    Read `ClosingController.php` and `SelectClosingQueryHandler.php`. The research found that `ClosingController::getOpened()` correctly scopes by store AND terminal, but the `list` endpoint (SelectClosingQuery) does not filter by terminal by default.

    For DATA-03 (Z-Report session isolation), the concern is that when Closing data is fetched for reports, it must be scoped to the correct terminal session. Check whether:
    1. The `SelectClosingQueryHandler` accepts store/terminal filter parameters
    2. The ClosingController list endpoint passes these filters through

    If the SelectClosingQuery already accepts store/terminal fields from the request and the handler applies them as WHERE clauses, then DATA-03 is satisfied at the query level. If not, add store and terminal filters to the SelectClosingQueryHandler's query builder when those parameters are provided.

    **NOTE:** The full Z-Report computation endpoint (computing order totals within a session time window) is a Phase 5 deliverable. For Phase 2, DATA-03 requires that closing queries return only data for the correct session -- no cross-terminal data leakage. The key fix is ensuring the SelectClosingQuery filters by terminal when a terminal parameter is provided.
  </action>
  <verify>
    1. Count isSuspended references in ReportController: `grep -c "isSuspended" back/src/Controller/Api/Admin/ReportController.php` -- should match the number of query builders (at least 8-10 occurrences across all methods).
    2. Verify no remaining `prod.cost` in profit queries: `grep "prod.cost" back/src/Controller/Api/Admin/ReportController.php` -- should return zero results in profit/cost calculation lines (may still appear in non-cost contexts like product name).
    3. Verify costAtSale usage: `grep "costAtSale" back/src/Controller/Api/Admin/ReportController.php` -- should show op.costAtSale in profit queries.
    4. Verify isReturned filter on payment queries: `grep -c "isReturned" back/src/Controller/Api/Admin/ReportController.php` -- should be present in payment breakdown queries.
    5. `docker exec dev-php-polymer php /var/www/html/polymer/bin/console cache:clear` -- succeeds without errors.
    6. Verify Symfony container compiles: `docker exec dev-php-polymer php /var/www/html/polymer/bin/console debug:router | head -5` -- should list routes without errors, confirming no PHP parse errors in modified files.
  </verify>
  <done>
    - Every revenue/count/payment query in ReportController.php filters out suspended orders (isSuspended != true OR isSuspended IS NULL)
    - Payment breakdown queries in sales() and daily() also filter out returned orders (isReturned = false)
    - Profit queries use op.costAtSale instead of prod.cost for cost calculations
    - Closing/SelectClosingQuery properly scopes by terminal when terminal parameter is provided
    - No PHP errors -- cache:clear and debug:router succeed
  </done>
</task>

<task type="auto">
  <name>Task 2: Smoke test queries against live database</name>
  <files></files>
  <action>
    Run smoke test queries directly against the database via Doctrine to verify the fixed queries return sensible results and do not throw SQL errors.

    **A. Test that the application loads without errors:**
    ```bash
    docker exec dev-php-polymer php /var/www/html/polymer/bin/console cache:clear
    docker exec dev-php-polymer php /var/www/html/polymer/bin/console debug:router | grep -i report
    ```
    This confirms ReportController routes are registered and the container compiles.

    **B. Run DQL verification queries:**
    Use `doctrine:query:dql` to test the key fixed queries:

    1. Test isSuspended filter works:
    ```bash
    docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:query:dql "SELECT COUNT(o) FROM App\Entity\Order o WHERE o.isDeleted = false AND (o.isSuspended != true OR o.isSuspended IS NULL)"
    ```
    Should return a count without errors.

    2. Test costAtSale is queryable:
    ```bash
    docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:query:dql "SELECT COALESCE(SUM(COALESCE(op.costAtSale, 0) * op.quantity), 0) as totalCost FROM App\Entity\OrderProduct op"
    ```
    Should return a numeric total without errors.

    3. Test suspended orders are excluded from revenue:
    ```bash
    docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:query:dql "SELECT COUNT(o) as total_orders FROM App\Entity\Order o WHERE o.isDeleted = false AND o.isSuspended = true"
    ```
    This shows how many suspended orders exist. If > 0, the filter is meaningful.

    **C. Verify no regression on Closing queries:**
    ```bash
    docker exec dev-php-polymer php /var/www/html/polymer/bin/console doctrine:query:dql "SELECT c.id FROM App\Entity\Closing c" --max-result=3
    ```
    Should return results without errors, confirming Closing entity still maps correctly after decimal migration.

    **D. If any DQL query fails:** Read the error message carefully. Common issues:
    - "Column not found" = migration not run or column name mismatch
    - "Undefined field" = entity property name mismatch (PHP property vs DQL field name)
    - Fix the issue in ReportController.php or entity and re-test.
  </action>
  <verify>
    1. All 4 DQL test queries execute without errors.
    2. `docker exec dev-php-polymer php /var/www/html/polymer/bin/console cache:clear` succeeds.
    3. `docker exec dev-php-polymer php /var/www/html/polymer/bin/console debug:router | grep -i report` shows report routes.
  </verify>
  <done>
    - All DQL queries execute successfully against the live database
    - isSuspended filter is syntactically valid and returns results
    - costAtSale is queryable in DQL aggregations
    - Closing entity queries work after decimal migration
    - No PHP or SQL errors in the application container
  </done>
</task>

</tasks>

<verification>
1. ReportController.php has isSuspended filter in EVERY query that counts orders or computes revenue/profit.
2. Payment breakdown queries filter both isSuspended and isReturned.
3. Profit queries reference op.costAtSale, not prod.cost.
4. Closing list queries scope by terminal when parameter provided.
5. DQL smoke tests pass against live database.
6. Symfony cache:clear and debug:router succeed without errors.
</verification>

<success_criteria>
- DATA-01: All revenue/profit/daily queries in ReportController exclude suspended orders. A suspended order does NOT appear in daily totals.
- DATA-03: Closing list queries filter by terminal when terminal parameter is provided, preventing cross-session data leakage. (Full Z-Report computation is Phase 5.)
- Profit calculations use costAtSale from OrderProduct, not live Product.cost.
- Payment breakdowns exclude returned orders.
- All queries execute without SQL errors against the live database.
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model-corrections/02-02-SUMMARY.md`
</output>
