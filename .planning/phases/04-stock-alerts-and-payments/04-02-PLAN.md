---
phase: 04-stock-alerts-and-payments
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - front/src/api/model/payment.type.ts
  - front/src/api/routing/routes/backend.app.ts
  - front/src/app-frontend/components/stock/stock.alert.badge.tsx
  - front/src/app-frontend/components/modes/footer.tsx
  - front/src/app-admin/routes/frontend.routes.ts
  - front/src/app-admin/containers/inventory/stock-alerts.tsx
  - front/src/app-admin/containers/layout/sidebar.tsx
  - front/src/app-admin/app.tsx
autonomous: true
requirements:
  - STOCK-03
  - STOCK-04

must_haves:
  truths:
    - "POS screen shows a badge with the count of low-stock products without the cashier navigating away"
    - "The badge count refreshes automatically every 60 seconds via polling"
    - "Admin panel has a Stock Alerts page listing products below their reorder threshold"
    - "Admin stock alerts page can be filtered by store"
    - "PaymentType TypeScript model includes the new category field"
  artifacts:
    - path: "front/src/app-frontend/components/stock/stock.alert.badge.tsx"
      provides: "POS stock alert badge with 60s polling"
      contains: "refetchInterval"
    - path: "front/src/app-frontend/components/modes/footer.tsx"
      provides: "Footer with StockAlertBadge injected"
      contains: "StockAlertBadge"
    - path: "front/src/app-admin/containers/inventory/stock-alerts.tsx"
      provides: "Admin stock alerts page with store filter"
      contains: "stock-alerts"
    - path: "front/src/app-admin/containers/layout/sidebar.tsx"
      provides: "Sidebar with Inventory section for ROLE_MANAGER"
      contains: "Stock Alerts"
    - path: "front/src/app-admin/app.tsx"
      provides: "Route for /inventory/alerts with RequireRole ROLE_MANAGER"
      contains: "INVENTORY_ALERTS"
    - path: "front/src/api/model/payment.type.ts"
      provides: "PaymentType interface with category field"
      contains: "category"
  key_links:
    - from: "front/src/app-frontend/components/stock/stock.alert.badge.tsx"
      to: "/api/admin/stock/alerts"
      via: "useQuery with STOCK_ALERTS URL constant"
      pattern: "STOCK_ALERTS"
    - from: "front/src/app-admin/containers/inventory/stock-alerts.tsx"
      to: "/api/admin/stock/alerts"
      via: "useApi hook with STOCK_ALERTS URL constant"
      pattern: "STOCK_ALERTS"
    - from: "front/src/app-admin/app.tsx"
      to: "front/src/app-admin/containers/inventory/stock-alerts.tsx"
      via: "React Router Route element"
      pattern: "INVENTORY_ALERTS"
---

<objective>
Frontend surfaces for stock alerts (POS badge + admin page) and PaymentType model update.

Purpose: Give the cashier a persistent visual indicator of low-stock products via a badge in the POS footer, provide the admin/manager a dedicated page to view and filter stock alerts by store, and update the PaymentType TypeScript model to include the new `category` field from the backend.

Output: StockAlertBadge component with 60s polling in POS footer, admin Stock Alerts page with store filter and sidebar navigation, updated PaymentType interface.
</objective>

<execution_context>
@/Users/abdellahi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abdellahi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-stock-alerts-and-payments/04-RESEARCH.md
@.planning/phases/04-stock-alerts-and-payments/04-01-SUMMARY.md

Key reference files:
@front/src/api/model/payment.type.ts
@front/src/api/routing/routes/backend.app.ts
@front/src/app-frontend/components/modes/footer.tsx
@front/src/app-admin/containers/layout/sidebar.tsx
@front/src/app-admin/app.tsx
@front/src/app-admin/routes/frontend.routes.ts
@front/src/api/hooks/use.api.ts (useApi hook pattern)
@front/src/app-frontend/components/sale/sale.closing.tsx (useQuery + store selector pattern)
@front/src/duck/store/store.selector.ts (getStore selector)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PaymentType model and add StockAlertBadge to POS footer</name>
  <files>
    front/src/api/model/payment.type.ts
    front/src/api/routing/routes/backend.app.ts
    front/src/app-frontend/components/stock/stock.alert.badge.tsx
    front/src/app-frontend/components/modes/footer.tsx
  </files>
  <action>
1. **payment.type.ts** — Add the `category` field to the `PaymentType` interface:

```ts
export interface PaymentType extends HydraId, HydraType {
  id: string;
  name: string;
  type: string;
  category: 'cash' | 'mobile' | 'credit';  // NEW — for Z-Report grouping (PAY-02)
  canHaveChangeDue?: boolean;
  stores: Store[];
  isActive: boolean;
}
```

This field will be populated by the API Platform serializer from the `Payment.category` column added in plan 04-01. No frontend logic change needed yet — Phase 5 (Z-Report) will consume this field.

2. **backend.app.ts** — Add the stock alerts URL constant at the end of the file, alongside other admin endpoint URLs:

```ts
export const STOCK_ALERTS = scopeUrl('/admin/stock/alerts');
```

3. **stock.alert.badge.tsx** — Create a new file at `front/src/app-frontend/components/stock/stock.alert.badge.tsx`:

```tsx
import { useQuery } from '@tanstack/react-query';
import { Badge, Tooltip } from 'antd';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faBoxOpen } from '@fortawesome/free-solid-svg-icons';
import { useSelector } from 'react-redux';
import { getStore } from '../../../duck/store/store.selector';
import { jsonRequest } from '../../../api/request/request';
import { STOCK_ALERTS } from '../../../api/routing/routes/backend.app';
import { useTranslation } from 'react-i18next';

export const StockAlertBadge = () => {
  const store = useSelector(getStore);
  const { t } = useTranslation();

  const { data } = useQuery(
    ['stock-alerts', store?.id],
    async () => {
      const res = await jsonRequest(`${STOCK_ALERTS}?store=${store?.id}`);
      return res.json();
    },
    {
      refetchInterval: 60_000,
      enabled: !!store?.id,
      refetchOnWindowFocus: false,
    }
  );

  const count = data?.count ?? 0;

  return (
    <Tooltip title={t('Low Stock Alerts')}>
      <button className="btn btn-lg">
        <Badge count={count} overflowCount={99} size="small">
          <FontAwesomeIcon icon={faBoxOpen} className="text-warning" />
        </Badge>
      </button>
    </Tooltip>
  );
};
```

Key decisions:
- Uses `useQuery` with `refetchInterval: 60_000` (60 seconds polling) per research recommendation. NOT localforage — stock alerts must always be fresh.
- `enabled: !!store?.id` prevents fetching before store is loaded.
- `refetchOnWindowFocus: false` avoids unnecessary API calls when window regains focus.
- Uses FontAwesome `faBoxOpen` icon (POS footer uses FontAwesome, not Bootstrap Icons).
- Ant Design `Badge` with `count={0}` renders no badge bubble (standard behavior) — so the icon is always visible but badge only shows when count > 0.
- `size="small"` keeps the badge compact in the footer bar.

4. **footer.tsx** — Import and inject `StockAlertBadge` before the first separator in the footer, after `<More />`:

```tsx
import { StockAlertBadge } from "../stock/stock.alert.badge";

export const Footer = () => {
  return (
    <>
      <Expenses />
      <PurchaseTabs />
      <More />
      <StockAlertBadge />
      <span className="w-[2px] bg-gray-500 h-full"></span>
      <SaleHistory />
      <SaleClosing />
      <span className="w-[2px] bg-gray-500 h-full"></span>
      <Shortcuts />
      <span className="w-[2px] bg-gray-500 h-full"></span>
      <Logout />
    </>
  );
};
```

Place `<StockAlertBadge />` after `<More />` and before the separator. This puts the inventory alert next to the other inventory-related buttons (PurchaseTabs, More) and keeps it visible without navigating away from the POS screen.
  </action>
  <verify>
1. `cd /Users/abdellahi/Documents/POS/Pointe_de_Vente/front && npx tsc --noEmit` — TypeScript compiles with no errors.
2. Visual check: Open the POS screen in the browser. The footer should show a box icon. If any products are below their reorder level, a red badge with the count appears.
3. Open browser DevTools Network tab: The request `GET /api/admin/stock/alerts?store=X` should fire immediately on POS load and repeat every 60 seconds.
  </verify>
  <done>PaymentType interface includes `category: 'cash' | 'mobile' | 'credit'`. POS footer displays a StockAlertBadge with 60-second polling. Badge shows count of low-stock products. Icon is always visible; red badge only appears when count > 0.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin stock alerts page with store filter and sidebar entry</name>
  <files>
    front/src/app-admin/routes/frontend.routes.ts
    front/src/app-admin/containers/inventory/stock-alerts.tsx
    front/src/app-admin/containers/layout/sidebar.tsx
    front/src/app-admin/app.tsx
  </files>
  <action>
1. **frontend.routes.ts** — Add the inventory alerts route constant:

```ts
export const INVENTORY_ALERTS = staticRoute('/inventory/alerts');
```

Add it after the `REPORTS_DAILY` line, in the protected routes section.

2. **stock-alerts.tsx** — Create a new file at `front/src/app-admin/containers/inventory/stock-alerts.tsx`. Create the `inventory` directory if it does not exist. Follow the existing admin page pattern (Dashboard layout wrapper + data table):

```tsx
import React, { useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useQuery } from '@tanstack/react-query';
import { jsonRequest } from '../../../api/request/request';
import { STOCK_ALERTS, STORE_LIST } from '../../../api/routing/routes/backend.app';
import { withCurrency } from '../../../lib/currency/currency';
import { Layout } from '../layout/layout';

interface StockAlertItem {
  productId: number;
  productName: string;
  storeId: number;
  storeName: string;
  quantity: number;
  reOrderLevel: number;
}

interface StoreOption {
  id: number;
  name: string;
}

export const StockAlerts = () => {
  const { t } = useTranslation();
  const [storeFilter, setStoreFilter] = useState<string>('');

  // Load stores for filter dropdown
  const { data: storesData } = useQuery(
    ['stores-list'],
    async () => {
      const res = await jsonRequest(STORE_LIST);
      return res.json();
    }
  );

  // Load stock alerts with store filter
  const { data, isLoading } = useQuery(
    ['stock-alerts-admin', storeFilter],
    async () => {
      const url = storeFilter
        ? `${STOCK_ALERTS}?store=${storeFilter}`
        : STOCK_ALERTS;
      const res = await jsonRequest(url);
      return res.json();
    }
  );

  const alerts: StockAlertItem[] = data?.list ?? [];
  const stores: StoreOption[] = storesData?.['hydra:member'] ?? storesData ?? [];

  return (
    <Layout>
      <main id="main" className="main">
        <div className="pagetitle">
          <h1>{t('Stock Alerts')}</h1>
        </div>

        <section className="section">
          <div className="row">
            <div className="col-12">
              <div className="card">
                <div className="card-body">
                  <div className="d-flex justify-content-between align-items-center mt-3 mb-3">
                    <h5 className="card-title mb-0">
                      {t('Products below reorder level')}
                      {data?.count !== undefined && (
                        <span className="badge bg-danger ms-2">{data.count}</span>
                      )}
                    </h5>
                    <div>
                      <select
                        className="form-select"
                        value={storeFilter}
                        onChange={(e) => setStoreFilter(e.target.value)}
                      >
                        <option value="">{t('All Stores')}</option>
                        {Array.isArray(stores) && stores.map((store: any) => (
                          <option key={store.id} value={store.id}>
                            {store.name}
                          </option>
                        ))}
                      </select>
                    </div>
                  </div>

                  {isLoading ? (
                    <div className="text-center py-4">
                      <div className="spinner-border text-primary" role="status">
                        <span className="visually-hidden">{t('Loading...')}</span>
                      </div>
                    </div>
                  ) : alerts.length === 0 ? (
                    <div className="alert alert-success">
                      {t('All products are above their reorder levels.')}
                    </div>
                  ) : (
                    <table className="table table-hover">
                      <thead>
                        <tr>
                          <th>{t('Product')}</th>
                          <th>{t('Store')}</th>
                          <th className="text-end">{t('Current Stock')}</th>
                          <th className="text-end">{t('Reorder Level')}</th>
                          <th className="text-end">{t('Deficit')}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {alerts.map((item) => (
                          <tr key={`${item.productId}-${item.storeId}`}>
                            <td>{item.productName}</td>
                            <td>{item.storeName}</td>
                            <td className={`text-end ${item.quantity <= 0 ? 'text-danger fw-bold' : 'text-warning'}`}>
                              {item.quantity}
                            </td>
                            <td className="text-end">{item.reOrderLevel}</td>
                            <td className="text-end text-danger">
                              {(item.reOrderLevel - item.quantity).toFixed(0)}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </Layout>
  );
};
```

Key decisions:
- Uses `useQuery` directly (not `useApi`) since the stock alerts endpoint returns a flat list, not a paginated Hydra collection. The `useApi` hook is designed for Hydra pagination.
- Store filter dropdown loads stores from the existing `STORE_LIST` API Platform endpoint.
- Table shows product name, store name, current stock, reorder level, and deficit (reOrderLevel - quantity).
- Zero or negative stock rows highlighted in red bold; low stock in warning color.
- When no alerts exist, shows a success message.

3. **sidebar.tsx** — Add an "Inventory" section visible to `isManager`, between the Reports section and the Administration section. Add the import for `INVENTORY_ALERTS`:

Add to imports at top:
```ts
import {DASHBOARD, REPORTS_SALES, REPORTS_PROFIT, REPORTS_DAILY, USERS, INVENTORY_ALERTS} from "../../routes/frontend.routes";
```

Add the Inventory section inside the `{isManager && (...)}` block, AFTER the Daily Report `</li>` and BEFORE the closing `</>` of the manager section:

```tsx
<li className="nav-heading">{t('Inventory')}</li>

<li className="nav-item">
  <Link className={classNames(
    "nav-link", location.pathname === INVENTORY_ALERTS ? 'active' : 'collapsed'
  )} to={INVENTORY_ALERTS}>
    <i className="bi bi-exclamation-triangle"></i>
    <span>{t('Stock Alerts')}</span>
  </Link>
</li>
```

Uses `bi bi-exclamation-triangle` (Bootstrap Icon) consistent with the admin sidebar icon pattern. Visible to `ROLE_MANAGER` (same gate as reports).

4. **app.tsx** — Add the route for the stock alerts page. Add imports and route:

Add to imports:
```ts
import {INVENTORY_ALERTS} from "./routes/frontend.routes";
import {StockAlerts} from "./containers/inventory/stock-alerts";
```

Update the import line for frontend.routes to include `INVENTORY_ALERTS`:
```ts
import {DASHBOARD, FORGOT_PASSWORD, LOGIN, PROFILE, USERS, USERS_CREATE, USERS_EDIT, REPORTS_SALES, REPORTS_PROFIT, REPORTS_DAILY, INVENTORY_ALERTS} from "./routes/frontend.routes";
```

Add the route after the REPORTS_DAILY route and before the 404 catch-all:
```tsx
<Route path={INVENTORY_ALERTS} element={<RequireAuth><RequireRole role="ROLE_MANAGER"><StockAlerts/></RequireRole></RequireAuth>}/>
```

This gates the page to `ROLE_MANAGER` — consistent with how report pages are gated. The sidebar already checks `isManager` before showing the link.
  </action>
  <verify>
1. `cd /Users/abdellahi/Documents/POS/Pointe_de_Vente/front && npx tsc --noEmit` — TypeScript compiles with no errors.
2. Visual check: Log in as a MANAGER user in the admin panel. The sidebar should show an "Inventory" heading with a "Stock Alerts" link. Clicking it navigates to `/inventory/alerts`.
3. The stock alerts page shows a table of products below their reorder level. The store filter dropdown works — selecting a store re-fetches the data filtered to that store.
4. A non-manager user (VENDEUR) should not see the Inventory section in the sidebar, and navigating directly to `/inventory/alerts` should redirect or show access denied.
  </verify>
  <done>Admin panel has a Stock Alerts page at `/inventory/alerts` gated to ROLE_MANAGER. The page displays a table of products below reorder level with product name, store, stock, threshold, and deficit. A store filter dropdown filters results. The sidebar shows an "Inventory" section with a "Stock Alerts" link for managers.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd /Users/abdellahi/Documents/POS/Pointe_de_Vente/front && npx tsc --noEmit` passes with no errors
2. POS footer shows stock alert badge — opens POS in browser, verify badge icon appears
3. Badge count updates — change a product's stock to below its reOrderLevel, wait 60s or refresh, badge count increases
4. Admin sidebar shows "Stock Alerts" under "Inventory" heading for ROLE_MANAGER users
5. Admin stock alerts page loads data and store filter works
6. PaymentType interface includes `category` field — confirmed in `payment.type.ts`
</verification>

<success_criteria>
- POS footer displays a stock alert badge with count of low-stock products, polling every 60 seconds
- Admin panel has a stock alerts page at /inventory/alerts with store filter, accessible to ROLE_MANAGER
- PaymentType TypeScript model includes `category: 'cash' | 'mobile' | 'credit'`
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-stock-alerts-and-payments/04-02-SUMMARY.md`
</output>
