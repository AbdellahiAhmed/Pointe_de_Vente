---
phase: 08-restaurant-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/restaurant-extension.md
autonomous: true
requirements:
  - REST-01
  - REST-02

must_haves:
  truths:
    - "The document describes table management with zones, table entities, and a status state machine (LIBRE/OCCUPEE/ADDITION_DEMANDEE)"
    - "The document describes the modifier system with ModifierGroup/Modifier hierarchy, product attachment, and OrderItemModifier capture"
    - "The document describes kitchen order flow (KOT) with fire action, status lifecycle (RECU/EN_PREPARATION/PRET/LIVRE), and station routing"
    - "The document describes the kitchen display screen (KDS) with Mercure SSE real-time updates, bump workflow, and ready notifications"
    - "The document is written in French with Arabic section headers using the FR / AR inline pattern"
    - "The document contains entity relationship descriptions, state machine diagrams, API endpoint tables, and sequence flow descriptions"
  artifacts:
    - path: "docs/restaurant-extension.md"
      provides: "Complete restaurant extension technical design document"
      contains: "Extension Restaurant de VelociPOS"
  key_links:
    - from: "docs/restaurant-extension.md section 2 (Data Model)"
      to: "Existing Order, OrderProduct, Store, Terminal, Product entities"
      via: "Explicit references showing how new entities extend existing ones"
      pattern: "Order|OrderProduct|Store|Terminal|Product"
    - from: "docs/restaurant-extension.md section 5 (KOT)"
      to: "docs/restaurant-extension.md section 6 (KDS)"
      via: "Mercure SSE publish/subscribe flow connecting KOT fire to KDS display"
      pattern: "Mercure|SSE|/kitchen/tickets"
---

<objective>
Write the complete restaurant extension technical design document for VelociPOS.

Purpose: Produce a professional bilingual (FR/AR) technical specification suitable for academic presentation, demonstrating how the existing POS system would be extended to handle restaurant operations (table management, modifiers, kitchen order flow, kitchen display screen) — without any code implementation.

Output: `docs/restaurant-extension.md`
</objective>

<execution_context>
@/Users/abdellahi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abdellahi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-restaurant-documentation/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write restaurant extension design document</name>
  <files>docs/restaurant-extension.md</files>
  <action>
Create the directory `docs/` at the project root if it does not exist, then write `docs/restaurant-extension.md`.

The document MUST follow the exact structure from 08-RESEARCH.md (7 major sections). Write entirely in French body text with Arabic section headers inline using the " / عربي" separator pattern.

**Section 1 — Introduction et Perimetre:**
- State the document's purpose: describe the restaurant extension of VelociPOS at design level for academic presentation
- Define functional scope: table management, modifier system, kitchen order flow (KOT), kitchen display screen (KDS)
- Explicitly state what is OUT of scope: no code implementation, no deployment, no floor plan drag-and-drop editor
- Summarize the current architecture briefly: Symfony 5.4 + API Platform + Doctrine ORM + React 18 + Vite + Mercure SSE

**Section 2 — Extension du Modele de Donnees / توسيع نموذج البيانات:**
- Subsection 2.1: Existing entities modified — Store (hasRestaurantMode bool), Terminal (type enum POS/KDS/WAITER), Order (tableId, coverCount, orderType EMPORTER/SUR_PLACE), OrderProduct (OrderItemModifier references)
- Subsection 2.2: New entities — Zone, RestaurantTable, ModifierGroup, Modifier, OrderItemModifier, KitchenTicket, KitchenTicketItem. Use the exact field definitions from the RESEARCH.md entity designs section. Include types, constraints, and relationships.
- Subsection 2.3: Entity-relationship diagram using Mermaid erDiagram syntax showing ALL entities (existing modified + new) with their relationships (OneToMany, ManyToOne, ManyToMany, OneToOne)

**Section 3 — Gestion des Tables / ادارة الطاولات:**
- 3.1 Zones and floor plan: zones belong to a Store, each zone has tables listed as cards (not drag-and-drop). Describe the list-based UI approach. Note graphical floor plan as future enhancement.
- 3.2 Table lifecycle state machine: Draw the FSM in ASCII art or Mermaid stateDiagram. States: LIBRE -> OCCUPEE -> ADDITION_DEMANDEE -> LIBRE. Show triggers for each transition ("Ouvrir table", "Demander addition", "Cloturer vente"). The OCCUPEE -> LIBRE shortcut when closing without bill request.
- 3.3 Table management UI description: Describe the waiter-facing interface — zone selector, table cards with color-coded status, tap to open/manage, cover count input
- 3.4 Table merge: Describe how multiple tables combine into a single Order for large parties, and how the merge is reversed on close

**Section 4 — Systeme de Modifiers / نظام الاضافات:**
- 4.1 ModifierGroup/Modifier structure: Describe the hierarchy with a concrete example (Burger -> Cuisson group -> Saignant/A point/Bien cuit). Show minSelections, maxSelections, required constraints.
- 4.2 Product attachment: ManyToMany relationship — one ModifierGroup can be shared across multiple products. Describe admin UI for assigning groups to products.
- 4.3 Order capture (OrderItemModifier): When cashier/waiter selects modifiers, they are captured as OrderItemModifier records with priceAuMomentVente snapshot (same immutable pattern as costAtSale from Phase 2). Show a concrete example with price adjustments.
- 4.4 Kitchen ticket display: Show exactly how modifiers render on the KOT. Example: "Table 4 — Burger x2 | Cuisson: A point | Sans oignon"

**Section 5 — Flux de Commande Cuisine (KOT) / تدفق اوامر المطبخ:**
- 5.1 Firing a KOT: Waiter explicitly fires order (not automatic at payment). One KOT per fire action. Describe the FireKitchenTicketCommand CQRS pattern (at design level, no PHP code).
- 5.2 KOT status lifecycle: RECU -> EN_PREPARATION -> PRET -> LIVRE. Draw as Mermaid stateDiagram or ASCII. Show what triggers each transition and who triggers it (kitchen staff on KDS).
- 5.3 Station routing: Products have a stationCible (via Product or Category). Items in a single order may route to different stations. Describe simple case (one unified KDS) as baseline, station-level filtering as advanced option.
- 5.4 Sequence diagram: Use Mermaid sequenceDiagram syntax showing the full flow: Waiter -> Backend -> Mercure -> KDS -> Backend -> Mercure -> Waiter (for ready notification). Include the POST/PATCH endpoints and Mercure topic names (/kitchen/tickets, /pos/ready-alerts).

**Section 6 — Ecran Cuisine (KDS) / شاشة المطبخ:**
- 6.1 Real-time architecture: Mercure SSE — the KDS React app subscribes to /kitchen/tickets topic via EventSource. Describe the publish/subscribe mechanism. Reference that Mercure is already in the Symfony ecosystem.
- 6.2 KDS interface description: Ticket cards in chronological order. Each card shows: table number, cover count, items with modifiers, elapsed time. Staff "bump" a ticket to advance status.
- 6.3 Color coding: Green (RECU, new), Yellow (EN_PREPARATION), Red (delayed beyond configurable threshold). Describe the visual urgency system.
- 6.4 Ready notification: When ticket bumped to PRET, Mercure publishes to /pos/ready-alerts. The waiter/POS app displays "Table N — Plat pret" notification.

**Section 7 — Considerations d'Implementation Future / اعتبارات التنفيذ المستقبلية:**
- 7.1 Database migration strategy: New tables added, existing tables receive nullable columns. No breaking changes.
- 7.2 Feature flag activation: Store.hasRestaurantMode flag enables/disables restaurant features per store. The existing POS continues to work unchanged when flag is off.
- 7.3 Impact on existing reports: Describe how restaurant orders (SUR_PLACE with table data) integrate into the existing Z-Report and profit reports without requiring changes — they are still Orders with OrderProducts.

**API Endpoints Table:**
Include the hypothetical API Platform endpoints table from RESEARCH.md (GET/POST zones, GET/PATCH tables, GET modifier-groups, POST/GET/PATCH kitchen-tickets).

**Role-Based Access Table:**
Include the RBAC extension table from RESEARCH.md (VENDEUR, MANAGER, ADMIN permissions for restaurant features).

**Formatting requirements:**
- Use `##` for major sections with bilingual headers (FR / AR)
- Use `###` for subsections
- Use Mermaid code blocks for diagrams (erDiagram, stateDiagram, sequenceDiagram)
- Use Markdown tables for entity fields, API endpoints, role permissions
- Professional academic tone in French throughout
- Currency references use MRU
- No code snippets (PHP, TypeScript) — this is a design document, not an implementation guide
- Minimum 300 lines to ensure adequate depth for academic presentation
  </action>
  <verify>
1. File exists: `ls docs/restaurant-extension.md`
2. Contains all 7 major sections: grep for "## 1.", "## 2.", "## 3.", "## 4.", "## 5.", "## 6.", "## 7."
3. Contains Arabic headers: grep for Arabic Unicode characters
4. Contains Mermaid diagrams: grep for "```mermaid"
5. Contains entity definitions: grep for "RestaurantTable", "ModifierGroup", "KitchenTicket"
6. Contains state machines: grep for "LIBRE", "OCCUPEE", "RECU", "EN_PREPARATION", "PRET"
7. Contains API endpoints table: grep for "/api/kitchen-tickets"
8. Contains Mercure references: grep for "Mercure"
9. References existing entities: grep for "OrderProduct", "Order", "Store"
10. Line count >= 300: `wc -l docs/restaurant-extension.md`
  </verify>
  <done>
A professional bilingual Markdown document exists at docs/restaurant-extension.md that:
- Describes all four restaurant subsystems (tables, modifiers, KOT, KDS) with enough detail for a technical reviewer to understand the proposed architecture
- Shows how new entities extend existing VelociPOS entities (Order, OrderProduct, Store, Terminal, Product)
- Contains Mermaid diagrams for entity relationships, state machines, and sequence flows
- Is written in French with Arabic section headers
- Includes API endpoint table, RBAC extension table, and implementation considerations
- Is at least 300 lines long, formatted with professional academic structure
  </done>
</task>

</tasks>

<verification>
After task completion, verify the document meets both requirements:

**REST-01 (technical content):**
- Section 3 covers table management (zones, status FSM, UI, merge)
- Section 4 covers modifier system (groups, product attachment, order capture, kitchen display)
- Section 5 covers kitchen order flow (KOT fire, status lifecycle, station routing, sequence)
- Section 6 covers kitchen display screen (Mercure SSE, interface, color coding, notifications)

**REST-02 (professional bilingual format):**
- French body text throughout
- Arabic section headers on all major sections
- Mermaid diagrams for visual clarity
- Structured tables for entity fields, endpoints, permissions
- Academic tone appropriate for presentation
</verification>

<success_criteria>
1. `docs/restaurant-extension.md` exists and is >= 300 lines
2. All 7 major sections present with bilingual headers
3. Entity-relationship diagram present (Mermaid erDiagram)
4. Table status state machine present (Mermaid stateDiagram or ASCII)
5. KOT status state machine present
6. Kitchen order sequence diagram present (Mermaid sequenceDiagram)
7. API endpoints table with all 8 hypothetical endpoints
8. RBAC extension table with 3 roles
9. All existing entities referenced (Order, OrderProduct, Store, Terminal, Product)
10. Mercure SSE architecture described with topic names
</success_criteria>

<output>
After completion, create `.planning/phases/08-restaurant-documentation/08-01-SUMMARY.md`
</output>
