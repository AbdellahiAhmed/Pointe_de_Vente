---
phase: 03-pmp-and-purchase-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - back/src/EventSubscriber/Purchase/PurchaseEvent.php
  - back/config/packages/stof_doctrine_extensions.yaml
  - front/src/app-frontend/components/settings/items/item.tsx
  - front/src/app-frontend/components/settings/items/items.tsx
  - front/src/language/lang.fr.json
  - front/src/language/lang.ar.json
autonomous: true
requirements:
  - PMP-01
  - PMP-02
  - PMP-03
  - PMP-04
  - PMP-05

must_haves:
  truths:
    - "After a purchase with updatePrice=true, the product's cost field reflects the weighted-average PMP formula result rounded to 2 decimal places"
    - "The product detail modal in admin displays the cost field with a label explicitly identifying it as PMP (not 'Purchase Price')"
    - "Gedmo Loggable audit trail is active — cost changes on Product are logged to ext_log_entries"
    - "Profit reports use costAtSale from the time of sale, not the current product cost"
  artifacts:
    - path: "back/src/EventSubscriber/Purchase/PurchaseEvent.php"
      provides: "PMP weighted-average calculation with round(..., 2)"
      contains: "round($totalValue / $totalQty, 2)"
    - path: "back/config/packages/stof_doctrine_extensions.yaml"
      provides: "Gedmo loggable extension enabled"
      contains: "loggable: true"
    - path: "front/src/app-frontend/components/settings/items/item.tsx"
      provides: "PMP label on product detail"
      contains: "PMP"
    - path: "front/src/language/lang.fr.json"
      provides: "French translation for PMP label"
      contains: "PMP"
    - path: "front/src/language/lang.ar.json"
      provides: "Arabic translation for PMP label"
      contains: "PMP"
  key_links:
    - from: "back/src/EventSubscriber/Purchase/PurchaseEvent.php"
      to: "Product.cost decimal(20,2)"
      via: "setCost((string) round(..., 2)) — precision matches DB column"
      pattern: "round\\(.*,\\s*2\\)"
    - from: "back/config/packages/stof_doctrine_extensions.yaml"
      to: "@Gedmo\\Loggable on Product entity"
      via: "loggable: true enables the existing annotations"
      pattern: "loggable:\\s*true"
---

<objective>
Close the remaining gaps in Phase 3 (PMP and Purchase Flow) by fixing the round precision mismatch, enabling the Gedmo audit trail, and relabeling the frontend PMP display.

Purpose: Most of Phase 3 was already implemented (PMP formula, costAtSale, profit queries). This plan closes three small gaps: (1) round() precision inconsistency between PHP code (4 places) and DB column (2 places), (2) Gedmo loggable not activated despite annotations being present, (3) frontend label says "Purchase Price" instead of explicitly identifying the value as PMP.

Output: Consistent PMP calculation, active audit trail on cost changes, and clear PMP labeling in admin UI.
</objective>

<execution_context>
@/Users/abdellahi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abdellahi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pmp-and-purchase-flow/03-RESEARCH.md

@back/src/EventSubscriber/Purchase/PurchaseEvent.php
@back/config/packages/stof_doctrine_extensions.yaml
@front/src/app-frontend/components/settings/items/item.tsx
@front/src/app-frontend/components/settings/items/items.tsx
@front/src/language/lang.fr.json
@front/src/language/lang.ar.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PMP round precision and enable Gedmo loggable</name>
  <files>
    back/src/EventSubscriber/Purchase/PurchaseEvent.php
    back/config/packages/stof_doctrine_extensions.yaml
  </files>
  <action>
1. In `back/src/EventSubscriber/Purchase/PurchaseEvent.php`, change `round($totalValue / $totalQty, 4)` to `round($totalValue / $totalQty, 2)`. This aligns the PHP calculation precision with the `decimal(20,2)` DB column, eliminating silent truncation by MariaDB. Do NOT change anything else in this file — the formula, the `updatePrice` gate, and the `(string)` cast are all correct.

2. In `back/config/packages/stof_doctrine_extensions.yaml`, add `loggable: true` under `orm.default` alongside the existing `softdeleteable` and `timestampable` entries. The Gedmo `@Loggable()` class annotation on `Product` and `@Versioned()` field annotation on `cost` already exist — enabling this config line activates the audit trail with zero entity changes. The Doctrine mapping for loggable entities is already configured in `doctrine.yaml`.

3. Clear the Symfony cache inside the Docker container to ensure the new config takes effect:
   ```
   docker exec dev-php-polymer php /var/www/html/polymer/bin/console cache:clear
   ```
  </action>
  <verify>
    Run `docker exec dev-php-polymer php /var/www/html/polymer/bin/console debug:container --tag=doctrine.event_listener 2>/dev/null || docker exec dev-php-polymer php /var/www/html/polymer/bin/console cache:clear` to confirm the cache clears successfully with the new config. Grep the PurchaseEvent.php file for `round(` to confirm it now says `round($totalValue / $totalQty, 2)`.
  </verify>
  <done>
    PurchaseEvent uses round(..., 2) matching the decimal(20,2) column. stof_doctrine_extensions.yaml includes loggable: true. Symfony cache clears without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Relabel PMP display in frontend and translations</name>
  <files>
    front/src/app-frontend/components/settings/items/item.tsx
    front/src/app-frontend/components/settings/items/items.tsx
    front/src/language/lang.fr.json
    front/src/language/lang.ar.json
  </files>
  <action>
1. In `front/src/app-frontend/components/settings/items/item.tsx` (line 75), change the translation key from `t("Purchase Price")` to `t("PMP (Avg. Cost)")`. This is the product detail modal that shows the cost field.

2. In `front/src/app-frontend/components/settings/items/items.tsx` (line 53), change the column header from `t("Purchase Price")` to `t("PMP (Avg. Cost)")`. This is the product list table column.

3. In `front/src/language/lang.fr.json`, add the new key:
   ```json
   "PMP (Avg. Cost)": "PMP (Coût Moyen Pondéré)"
   ```
   Keep the old "Purchase Price" key in case it's used elsewhere — do NOT delete it.

4. In `front/src/language/lang.ar.json`, add the new key:
   ```json
   "PMP (Avg. Cost)": "PMP (متوسط التكلفة المرجح)"
   ```
   Keep the old key as well.

5. Note: `lang.en.json` uses keys as-is for English, so "PMP (Avg. Cost)" will display directly without needing a translation entry. But if `lang.en.json` explicitly maps keys, add it there too.
  </action>
  <verify>
    Grep across the frontend codebase for `"Purchase Price"` — it should still exist in lang files (kept for backward compatibility) but NOT appear in `item.tsx` or `items.tsx` as a `t()` call. Grep for `"PMP (Avg. Cost)"` to confirm it appears in both TSX files and both translation files.
  </verify>
  <done>
    The product detail modal and product list table both display "PMP (Avg. Cost)" (or its French/Arabic translation) instead of "Purchase Price". The PMP label is unambiguous — users and evaluators can see this is the weighted average cost, satisfying PMP-04.
  </done>
</task>

</tasks>

<verification>
1. **PMP-01 (formula):** Confirmed by reading PurchaseEvent.php — the weighted-average formula is correct and round precision matches DB column.
2. **PMP-02 (decimal type):** Product.cost is decimal(20,2) — accepted as sufficient for MRU. Round precision aligned to 2.
3. **PMP-03 (costAtSale):** Already done in Phase 2 — no changes needed.
4. **PMP-04 (PMP visible in admin):** Label changed from "Purchase Price" to "PMP (Avg. Cost)" with FR/AR translations.
5. **PMP-05 (reports use costAtSale):** Already done in Phase 2 — no changes needed.
6. **Audit trail:** Gedmo loggable enabled — cost changes will be logged to ext_log_entries.
</verification>

<success_criteria>
- PurchaseEvent.php uses `round(..., 2)` not `round(..., 4)`
- stof_doctrine_extensions.yaml includes `loggable: true`
- Product detail modal shows "PMP (Avg. Cost)" label (not "Purchase Price")
- Product list table shows "PMP (Avg. Cost)" column header
- French and Arabic translation files contain the "PMP (Avg. Cost)" key
- Symfony cache clears without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-pmp-and-purchase-flow/03-01-SUMMARY.md`
</output>
